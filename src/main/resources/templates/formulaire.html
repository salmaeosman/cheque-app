<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire de chèque</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .cheque-container {
      position: relative;
      background-image: url('/images/cheque_bg.png');
      background-size: contain;
      background-repeat: no-repeat;
      width: 150%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 742 / 316;
      margin: auto;
    }
    .field {
      position: absolute;
      font-size: 0.8rem;
    }
    .beneficiaire { top: 36%; left: 13%; width: 80%; }
    .montant { top: 4%; right: 8%; width: 20%; }
    .ville { top: 45%; left: 45%; width: 20%; }
    .nomCheque { top: 75%; left: 9%; width: 4.5%; }
    .nomSerie { top: 75%; left: 16%; width: 4.5%; }
    .numeroSerie { top: 75%; left: 23%; width: 15%; }
    .date-cheque { top: 45%; left: 72%; width: 20%; }
    .submit-btn { margin-top: 20px; display: flex; justify-content: center; }
    .form-control { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
    .language-selection { margin-bottom: 20px; text-align: center; }
    .language-selection label { margin-right: 15px; font-weight: bold; }
    .error-message {
      position: absolute;
      font-size: 0.7rem;
      color: red;
    }
    .error-beneficiaire { top: 43%; left: 13%; }
    .error-nomCheque { top: 82%; left: 9%; }
    .error-nomSerie { top: 82%; left: 16%; }
    .error-numeroSerie { top: 82%; left: 23%; }
    .error-montant { top: 11%; right: 8%; }
    .error-ville { top: 52%; left: 45%; }
    .error-date { top: 52%; left: 72%; }
    #arabicKeyboard {
      display: none;
      margin: 20px auto;
      max-width: 600px;
      text-align: center;
    }
    .key {
      display: inline-block;
      margin: 3px;
      padding: 10px 15px;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    .key:hover { background-color: #ddd; }
  </style>
</head>
<body class="container mt-5">
  <h2 class="mb-4 text-center">Formulaire de chèque</h2>

  <div class="language-selection">
    <label>Langue :</label>
    <label><input type="radio" name="langue" value="fr" onclick="enableFields()"> Français</label>
    <label><input type="radio" name="langue" value="ar" onclick="enableFields()"> Arabe</label>
  </div>

  <form id="chequeForm" action="/cheque/enregistrer" method="post" novalidate>
    <div class="cheque-container">
      <input type="number" step="0.01" name="montant" id="montant" class="form-control field montant" placeholder="Montant" required disabled>
      <div class="error-message error-montant" id="errorMontant"></div>

      <input type="text" name="beneficiaire" id="beneficiaire" class="form-control field beneficiaire" placeholder="Nom du bénéficiaire" maxlength="50" required disabled>
      <div class="error-message error-beneficiaire" id="errorBeneficiaire"></div>

      <input type="text" name="ville" id="ville" class="form-control field ville" required disabled>
      <div class="error-message error-ville" id="errorVille"></div>

      <input type="text" name="nomCheque" id="nomCheque" class="form-control field nomCheque" placeholder="Nom du chèque" maxlength="1" required disabled>
      <div class="error-message error-nomCheque" id="errorNomCheque"></div>

      <input type="text" name="nomSerie" id="nomSerie" class="form-control field nomSerie" placeholder="Nom de série" maxlength="1" required disabled>
      <div class="error-message error-nomSerie" id="errorNomSerie"></div>

      <input type="text" name="numeroSerie" id="numeroSerie" class="form-control field numeroSerie" placeholder="Numéro de série" maxlength="10" required disabled>
      <div class="error-message error-numeroSerie" id="errorNumeroSerie"></div>

      <input type="date" name="date" id="date" class="form-control field date-cheque" required disabled>
      <div class="error-message error-date" id="errorDate"></div>

      <input type="hidden" name="langue" id="langueHidden">
    </div>

    <div class="submit-btn">
      <button type="submit" class="btn btn-success" id="submitBtn" disabled>Enregistrer le chèque</button>
    </div>
  </form>

  <div id="arabicKeyboard"></div>

<script>
const fields = [
  'montant', 'beneficiaire', 'ville', 'nomCheque',
  'nomSerie', 'numeroSerie', 'date'
];

const arabicLetters = ['ض','ص','ث','ق','ف','غ','ع','ه','خ','ح','ج','د','ش','س','ي','ب','ل','ا','ت','ن','م','ك','ط','ئ','ء','ؤ','ر','لا','ى','ة','و','ز','ظ','ذ'];

let currentInput = null;

function createArabicKeyboard() {
  const container = document.getElementById('arabicKeyboard');
  container.innerHTML = '';
  arabicLetters.forEach(letter => {
    const key = document.createElement('span');
    key.className = 'key';
    key.textContent = letter;
    key.onclick = () => {
      if (currentInput && currentInput.value.length < 50) {
        const start = currentInput.selectionStart;
        const end = currentInput.selectionEnd;
        const value = currentInput.value;
        currentInput.value = value.slice(0, start) + letter + value.slice(end);
        currentInput.focus();
        currentInput.selectionStart = currentInput.selectionEnd = start + 1;
        validateField(currentInput.id);
      }
    };
    container.appendChild(key);
  });
}

function enableFields() {
  const lang = document.querySelector('input[name="langue"]:checked')?.value;
  if (!lang) return;

  document.getElementById('langueHidden').value = lang;

  fields.forEach(id => {
    document.getElementById(id).disabled = false;
  });

  const beneficiaire = document.getElementById('beneficiaire');
  const ville = document.getElementById('ville');
  if (lang === 'ar') {
    beneficiaire.setAttribute('dir', 'rtl');
    ville.setAttribute('dir', 'rtl');
    ville.value = 'وجدة';
  } else {
    beneficiaire.setAttribute('dir', 'ltr');
    ville.setAttribute('dir', 'ltr');
    ville.value = 'Oujda';
  }

  document.getElementById('date').value ||= new Date().toISOString().split('T')[0];
  document.getElementById('submitBtn').disabled = false;
}

function validateField(id) {
  const val = document.getElementById(id).value.trim();
  const error = document.getElementById("error" + id.charAt(0).toUpperCase() + id.slice(1));
  let valid = true;

  switch (id) {
    case 'montant':
      valid = val !== "" && !isNaN(val) && Number(val) > 0;
      error.textContent = valid ? "" : "Montant invalide.";
      break;
    case 'beneficiaire':
      valid = val.length > 0;
      error.textContent = valid ? "" : "Champ obligatoire.";
      break;
    case 'ville':
      valid = val.length > 0;
      error.textContent = valid ? "" : "Champ obligatoire.";
      break;
    case 'nomCheque':
    case 'nomSerie':
      valid = /^[A-Za-z]$/.test(val);
      error.textContent = valid ? "" : "Lettre majuscule obligatoire.";
      break;
    case 'numeroSerie':
      valid = /^\d{1,10}$/.test(val);
      error.textContent = valid ? "" : "Numéro invalide.";
      break;
    case 'date':
      valid = val !== "";
      error.textContent = valid ? "" : "Date obligatoire.";
      break;
  }

  return valid;
}

function validateForm() {
  let valid = true;
  fields.forEach(id => {
    if (!validateField(id)) valid = false;
  });
  return valid;
}

document.addEventListener('DOMContentLoaded', () => {
  fields.forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('input', () => {
      if (id === 'beneficiaire') input.value = input.value.toUpperCase();
      if (['nomCheque', 'nomSerie'].includes(id)) input.value = input.value.toUpperCase();
      validateField(id);
    });

    input.addEventListener('focus', () => {
      const lang = document.getElementById('langueHidden').value;
      currentInput = input;
      if (lang === 'ar' && ['beneficiaire', 'ville'].includes(id)) {
        createArabicKeyboard();
        document.getElementById('arabicKeyboard').style.display = 'block';
      } else {
        document.getElementById('arabicKeyboard').style.display = 'none';
      }
    });

    input.addEventListener('blur', () => {
      if (!['beneficiaire', 'ville'].includes(id)) {
        document.getElementById('arabicKeyboard').style.display = 'none';
      }
    });
  });

  document.getElementById('chequeForm').addEventListener('submit', function (e) {
    if (!validateForm()) {
      e.preventDefault();
    }
  });
});
</script>
</body>
</html>
